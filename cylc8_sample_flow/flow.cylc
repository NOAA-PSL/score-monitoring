#!Jinja2

#===========================
# $$$ CYLC SUITE DOCUMENTATION BLOCK

# monitoring-stats :: cylc/suite.rc

# Email: jessica.knezha@noaa.gov, adam.schneider@noaa.gov

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see
# <http://www.gnu.org/licenses/>.

# =========================================================================
[meta]
	title = "SFS reanalysis development: scout runs and UFS-replay extensions"
	description = "Calculate statistics from the SFS reanalysis scout runs and UFS-replay extensions"

# parameters 
{% set MAIL_ADDRESS = '<EMAIL_ADDRESS>@noaa.gov' %}
{% set INITIAL_CYCLE_POINT = '19800101T00' %}
{% set FINAL_CYCLE_POINT = '19800106T00' %}
{% set ENV_PATH = 'scoutrun_monitoring.env' %}

[task parameters]
    stats = file_count, gsi_conv_obsfit, gsi_obsfit
    daily_background_stats = daily_mean_surface_background
    daily_analysis_stats = daily_mean_surface_analysis

[scheduler]
    UTC mode = True
    cycle point format = %Y%m%dT%H
    [[events]]
        mail events = startup, shutdown
    [[mail]]
        to = {{ MAIL_ADDRESS }}
    
[scheduling]
    initial cycle point = {{ INITIAL_CYCLE_POINT }}
    final cycle point = {{ FINAL_CYCLE_POINT }}
    runahead limit = P0
    [[graph]]
        # File check dependencies for each cycle point (T00, T06, T18) for the current day
        T00, T06, T18 = """
            file_check => store_data
        """

        # Store data daily, only after all file checks for T00 (bg), T06, T12, T18
        # and file_check for next day T00, T06 (an) pass
        T12 = """
            file_check => store_data
            
            file_check[-PT12H] & file_check[-PT6H] & file_check & file_check[+PT6H] &
            file_check[+PT12H] => store_data_daily_bg
          
            file_check[-PT6H] & file_check & file_check[+PT6H] & file_check[+PT12H] &
            file_check[+PT18H] => store_data_daily_an
        """
[runtime]
    [[root]]
        #platform = batch_partition
        [[[events]]]
            mail events = submission failed, failed, retry
        [[[mail]]]
            to = {{ MAIL_ADDRESS }}

    [[file_check]]
        script = """
	    bucket_file_count.py $CYLC_TASK_CYCLE_POINT {{ ENV_PATH }}
        """
	execution retry delays = 240*PT30M # if job fails, wait 30 minutes and try again
    [[print_cycle_valid]]
            script = "echo 'files found in bucket'" # for $CYCLE_TASK_CYCLE_POINT'"
    [[store_data]]
        execution retry delays = 60*PT1M # if job fails, wait one minute and try again
    [[store_data<stats>]]
        inherit=store_data
        script = """
             db_${CYLC_TASK_PARAM_stats}.py $CYLC_TASK_CYCLE_POINT {{ ENV_PATH }}
        """
    [[store_data_daily_bg]]
        execution retry delays = 60*PT1M # if job fails, wait one minute and try again
    [[store_data_daily_an]]
        execution retry delays = 60*PT1M # if job fails, wait one minute and try again
            
    [[store_data_daily_bg<daily_background_stats>]]
        inherit=store_data_daily_bg
        script = """
            db_${CYLC_TASK_PARAM_daily_background_stats}.py $CYLC_TASK_CYCLE_POINT {{ ENV_PATH }}
        """
    [[store_data_daily_an<daily_analysis_stats>]]
        inherit=store_data_daily_an
        script = """
            db_${CYLC_TASK_PARAM_daily_analysis_stats}.py $CYLC_TASK_CYCLE_POINT {{ ENV_PATH }}
        """

    [[data_stored]]
        script = "echo 'all data stored'"
